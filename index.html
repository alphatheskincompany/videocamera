<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apresentador Duo — Controlador + Transmissão (robusto)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 600:'#4f46e5',700:'#4338ca',800:'#3730a3' } },
          boxShadow: { glow: '0 10px 30px rgba(79,70,229,.45)'}
        }
      }
    }
  </script>
  <style>
    .btn{ @apply rounded-lg px-3 py-2 text-sm font-semibold bg-white/10 hover:bg-white/20; }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
  <!-- =================== CONTROLADOR (esta janela) =================== -->
  <header class="fixed top-0 inset-x-0 z-40">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex items-center justify-between rounded-2xl bg-white/5 ring-1 ring-white/10 backdrop-blur px-4 py-2">
        <div class="flex items-center gap-2">
          <div id="statusDot" class="h-2 w-2 rounded-full bg-white/40"></div>
          <span class="font-semibold tracking-tight">Apresentador Duo — Controlador</span>
          <span id="statusText" class="text-xs text-white/60 hidden sm:inline">Pronto</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnOpen" class="btn">Abrir janela de transmissão</button>
          <button id="btnStart" class="btn bg-brand-600 hover:bg-brand-700">Iniciar apresentação</button>
          <button id="btnStop" class="btn hidden">Encerrar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 max-w-7xl mx-auto px-4 grid gap-4 lg:grid-cols-3">
    <section class="lg:col-span-2 rounded-2xl bg-white/5 ring-1 ring-white/10 p-4">
      <h2 class="text-sm font-semibold mb-3">Controles</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2">
        <button id="cmdShare" class="btn">Selecionar Tela/Janela</button>
        <button id="cmdCam" class="btn">Ligar Câmera</button>
        <button id="cmdMic" class="btn">Mic: ligado</button>
        <button id="cmdFlip" class="btn">Espelhar câmera</button>
        <button id="cmdShape" class="btn">Forma: circular</button>
        <div class="flex gap-2">
          <button data-pos="tl" class="btn w-full">↖ topo-esq</button>
          <button data-pos="tr" class="btn w-full">↗ topo-dir</button>
        </div>
        <div class="flex gap-2">
          <button data-pos="bl" class="btn w-full">↙ base-esq</button>
          <button data-pos="br" class="btn w-full">↘ base-dir</button>
        </div>
        <button id="cmdSizeSmall" class="btn">Câmera: pequena</button>
        <button id="cmdSizeLarge" class="btn">Câmera: grande</button>
        <button id="cmdReset" class="btn">Reset palco</button>
      </div>
      <p class="text-xs text-white/60 mt-3">Dica: se o navegador bloquear pop-up, permita para este site. A captura de tela sempre é pedida <u>na janela de transmissão</u> (evita tela preta).</p>
    </section>

    <section class="rounded-2xl bg-white/5 ring-1 ring-white/10 p-4">
      <h2 class="text-sm font-semibold mb-3">Fluxo recomendado</h2>
      <ol class="list-decimal list-inside text-sm text-white/80 space-y-2">
        <li>Clique em <b>Abrir janela de transmissão</b>.</li>
        <li>Clique em <b>Iniciar apresentação</b> — a janela de transmissão vai pedir <i>Compartilhar tela</i> e <i>acesso à câmera</i>.</li>
        <li>Use os botões acima para posicionar/espelhar a câmera e mutar/desmutar o mic.</li>
      </ol>
    </section>
  </main>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-5 z-50 hidden rounded-lg bg-emerald-600 text-white px-4 py-2 shadow-lg"></div>

  <script>
    // ===== Canal de comunicação entre janelas
    const CH = new BroadcastChannel('duo-presenter');
    let pop = null; // janela de transmissão

    const qs = (sel) => document.querySelector(sel);
    const toast = (msg, ok=true)=>{
      const el = qs('#toast');
      el.textContent = msg;
      el.className = `fixed left-1/2 -translate-x-1/2 top-5 z-50 rounded-lg px-4 py-2 shadow-lg ${ok? 'bg-emerald-600':'bg-rose-600'} text-white`;
      el.style.display='block';
      clearTimeout(toast._t); toast._t=setTimeout(()=> el.style.display='none', 2200);
    };
    const setStatus = (t, active)=>{
      qs('#statusText').textContent=t;
      qs('#statusDot').className=`h-2 w-2 rounded-full ${active?'bg-emerald-400 animate-pulse':'bg-white/40'}`;
    };

    // ===== Abre a janela de transmissão com TODO o código embutido
    function openPop(){
      if(pop && !pop.closed){ pop.focus(); return; }
      pop = window.open('', 'apresentacao', 'width=1280,height=720,menubar=no,toolbar=no,location=no,status=no');
      if(!pop){ toast('Pop-up bloqueado. Permita pop-ups.', false); return; }
      pop.document.write(`<!DOCTYPE html><html><head><meta charset='utf-8'><title>Transmissão</title>
        <style>
          html,body{margin:0;height:100%;background:#000;overflow:hidden}
          #bg{position:fixed;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
          #cam{position:fixed;right:16px;bottom:16px;width:220px;height:220px;border-radius:50%;overflow:hidden;box-shadow:0 10px 20px rgba(0,0,0,.35);border:4px solid #4f46e5;object-fit:cover}
          .hidden{display:none}
          #hint{position:fixed;top:12px;left:12px;color:#fff9; font: 12px system-ui}
        </style>
      </head><body>
        <video id='bg' autoplay playsinline></video>
        <video id='cam' autoplay muted playsinline class='hidden'></video>
        <div id='hint'>Esta é a janela transmitida. Não há menus aqui.</div>
        <script>
          const CH = new BroadcastChannel('duo-presenter');
          const bg = document.getElementById('bg');
          const cam = document.getElementById('cam');
          let screenStream = null; let camStream = null; let micOn = true; let flipped=false; let circle=true;

          const message = (m)=> CH.postMessage({type:'toast', payload:m});

          async function share(){
            try{
              const disp = await navigator.mediaDevices.getDisplayMedia({ video:{cursor:'always'}, audio:{ echoCancellation:true, noiseSuppression:true } });
              screenStream = disp; bg.srcObject = disp; message('Tela/Janela compartilhada');
              disp.getVideoTracks()[0].onended = ()=>{ bg.srcObject=null; CH.postMessage({type:'status', payload:{text:'Parado', active:false}}); };
              // aplica estado de mic
              disp.getAudioTracks().forEach(t=> t.enabled = micOn);
              CH.postMessage({type:'status', payload:{text:'Transmitindo', active:true}});
            }catch(e){ message('Compartilhar tela cancelado/negado'); }
          }
          async function startCam(){
            try{
              const cs = await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:1280},height:{ideal:720}}, audio:false });
              camStream = cs; cam.srcObject = cs; cam.classList.remove('hidden');
              applyFlip();
            }catch(e){ message('Acesso à câmera negado'); }
          }
          function stopAll(){
            if(screenStream){ screenStream.getTracks().forEach(t=>t.stop()); screenStream=null; bg.srcObject=null; }
            if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; cam.srcObject=null; cam.classList.add('hidden'); }
            CH.postMessage({type:'status', payload:{text:'Pronto', active:false}});
          }
          function toggleMic(){ micOn=!micOn; if(screenStream){ screenStream.getAudioTracks().forEach(t=> t.enabled=micOn); } CH.postMessage({type:'mic', payload:micOn}); }
          function applyFlip(){ cam.style.transform = flipped?'scaleX(-1)':'none'; }
          function toggleFlip(){ flipped=!flipped; applyFlip(); }
          function toggleShape(){ circle=!circle; cam.style.borderRadius = circle? '50%':'16px'; }
          function setPos(pos){
            const pad=16, w=cam.offsetWidth, h=cam.offsetHeight;
            if(pos==='tl'){ cam.style.left=pad+'px'; cam.style.top=pad+'px'; cam.style.right=''; cam.style.bottom=''; }
            if(pos==='tr'){ cam.style.right=pad+'px'; cam.style.top=pad+'px'; cam.style.left=''; cam.style.bottom=''; }
            if(pos==='bl'){ cam.style.left=pad+'px'; cam.style.bottom=pad+'px'; cam.style.right=''; cam.style.top=''; }
            if(pos==='br'){ cam.style.right=pad+'px'; cam.style.bottom=pad+'px'; cam.style.left=''; cam.style.top=''; }
          }
          function setSize(sz){ cam.style.width = sz; cam.style.height = sz; }

          // arrastar localmente
          let drag=false, offX=0, offY=0;
          cam.addEventListener('mousedown', (e)=>{ drag=true; const r=cam.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; document.body.style.userSelect='none'; });
          document.addEventListener('mousemove', (e)=>{ if(!drag) return; let x=e.clientX-offX, y=e.clientY-offY; const maxX=innerWidth-cam.offsetWidth-8; const maxY=innerHeight-cam.offsetHeight-8; x=Math.max(8,Math.min(x,maxX)); y=Math.max(8,Math.min(y,maxY)); cam.style.left=x+'px'; cam.style.top=y+'px'; cam.style.right=''; cam.style.bottom=''; });
          document.addEventListener('mouseup', ()=>{ drag=false; document.body.style.userSelect=''; });

          // comandos vindos do controlador
          CH.onmessage = (ev)=>{
            const {type, payload} = ev.data || {};
            if(type==='cmd:start'){ share(); startCam(); }
            if(type==='cmd:stop'){ stopAll(); }
            if(type==='cmd:share'){ share(); }
            if(type==='cmd:cam'){ startCam(); }
            if(type==='cmd:mic'){ toggleMic(); }
            if(type==='cmd:flip'){ toggleFlip(); }
            if(type==='cmd:shape'){ toggleShape(); }
            if(type==='cmd:pos'){ setPos(payload); }
            if(type==='cmd:size'){ setSize(payload); }
            if(type==='cmd:reset'){ stopAll(); setTimeout(()=>{ /* noop */ },10); }
          };

          // sinaliza pronto ao controlador
          CH.postMessage({type:'stage:ready'});
        <\/script>
      </body></html>`);
      toast('Janela de transmissão aberta');
    }

    // ===== Wire dos botões do controlador
    document.getElementById('btnOpen').onclick = openPop;

    document.getElementById('btnStart').onclick = ()=>{
      openPop();
      CH.postMessage({type:'cmd:start'});
      document.getElementById('btnStart').classList.add('hidden');
      document.getElementById('btnStop').classList.remove('hidden');
      setStatus('Aguardando compartilhar…', true);
    };
    document.getElementById('btnStop').onclick = ()=>{ CH.postMessage({type:'cmd:stop'}); setStatus('Pronto', false); document.getElementById('btnStart').classList.remove('hidden'); document.getElementById('btnStop').classList.add('hidden'); };

    document.getElementById('cmdShare').onclick = ()=> CH.postMessage({type:'cmd:share'});
    document.getElementById('cmdCam').onclick   = ()=> CH.postMessage({type:'cmd:cam'});
    document.getElementById('cmdMic').onclick   = (e)=>{ CH.postMessage({type:'cmd:mic'}); e.target.textContent = e.target.textContent.includes('ligado')? 'Mic: mudo' : 'Mic: ligado'; };
    document.getElementById('cmdFlip').onclick  = ()=> CH.postMessage({type:'cmd:flip'});
    document.getElementById('cmdShape').onclick = (e)=>{ CH.postMessage({type:'cmd:shape'}); e.target.textContent = e.target.textContent.includes('circular')? 'Forma: quadrada' : 'Forma: circular'; };
    document.querySelectorAll('[data-pos]').forEach(btn=> btn.onclick = ()=> CH.postMessage({type:'cmd:pos', payload: btn.dataset.pos}));
    document.getElementById('cmdSizeSmall').onclick = ()=> CH.postMessage({type:'cmd:size', payload: '180px'});
    document.getElementById('cmdSizeLarge').onclick = ()=> CH.postMessage({type:'cmd:size', payload: '300px'});
    document.getElementById('cmdReset').onclick = ()=> CH.postMessage({type:'cmd:reset'});

    // feedbacks vindos da janela de transmissão
    CH.onmessage = (ev)=>{
      const {type, payload} = ev.data || {};
      if(type==='toast'){ toast(payload); }
      if(type==='status'){ setStatus(payload.text, payload.active); }
      if(type==='stage:ready'){ setStatus('Transmissão pronta', false); }
    };

    // segurança: fecha status se a janela for fechada manualmente
    window.addEventListener('message', ()=>{}, false);
  </script>
</body>
</html>
