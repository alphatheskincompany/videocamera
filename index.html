<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presenter ‚Äî Transmiss√£o Est√°vel (Popout √© a fonte)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 600:'#4f46e5',700:'#4338ca',800:'#3730a3' } },
          boxShadow: { glow: '0 10px 30px rgba(79,70,229,.45)'}
        }
      }
    }
  </script>
  <style>
    html,body{background:#0b0f1a}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(to bottom,rgba(255,255,255,.08),rgba(255,255,255,.04))}
    .btn{border-radius:12px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#4f46e5;color:#fff}
    .btn-primary:hover{background:#4338ca}
    .btn-ghost{background:rgba(255,255,255,.1);color:#fff}
    .btn-ghost:hover{background:rgba(255,255,255,.2)}
    #camBubble{cursor:move}
  </style>
</head>
<body class="text-white min-h-screen">
  <!-- Header -->
  <header class="fixed top-0 inset-x-0 z-40">
    <div class="mx-auto max-w-[1200px] px-4 py-4">
      <div class="glass ring-1 ring-white/10 rounded-2xl px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse" id="statusDot"></div>
          <h1 class="text-base font-semibold tracking-tight">Presenter ‚Äî Popout √© a FONTE</h1>
          <span class="text-xs text-white/60 hidden sm:inline" id="statusText">Pronto</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="openPopout" class="btn btn-primary">Abrir Janela de Transmiss√£o</button>
          <button id="stopAll" class="btn btn-ghost">Encerrar</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Conte√∫do principal com instru√ß√µes -->
  <main class="pt-24 mx-auto max-w-[1200px] px-4">
    <div class="grid md:grid-cols-2 gap-4">
      <section class="glass ring-1 ring-white/10 rounded-2xl p-4">
        <h2 class="text-sm font-semibold mb-2">Como usar</h2>
        <ol class="text-sm text-white/80 list-decimal list-inside space-y-1">
          <li>Clique <strong>"Abrir Janela de Transmiss√£o"</strong>.</li>
          <li>Na janela que abrir, clique em <strong>"Iniciar Compartilhamento"</strong> e escolha <strong>Tela inteira</strong> (recomendado).<br><span class="text-xs text-white/60">Dica: quando a captura parte do <em>popout</em>, ela continua mesmo se esta p√°gina for minimizada; s√≥ n√£o minimize o popout.</span></li>
          <li>Compartilhe <u>essa janela do popout</u> no Meet/Zoom/Teams (o p√∫blico ver√° apenas a transmiss√£o).</li>
        </ol>
      </section>
      <section class="glass ring-1 ring-white/10 rounded-2xl p-4">
        <h2 class="text-sm font-semibold mb-2">C√¢mera do apresentador (opcional)</h2>
        <div class="flex gap-2 mb-3">
          <button id="startCam" class="btn btn-ghost">üé• Ligar c√¢mera</button>
          <button id="flipCam" class="btn btn-ghost">‚Üî Espelhar</button>
          <button id="shapeCam" class="btn btn-ghost">‚¨õ/‚¨§ Forma</button>
        </div>
        <div class="relative aspect-video bg-black/40 ring-1 ring-white/10 rounded-xl overflow-hidden">
          <div id="camBubble" class="absolute right-4 bottom-4 w-[220px] h-[220px] rounded-full ring-4 ring-brand-600 overflow-hidden shadow-xl hidden select-none">
            <video id="camVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
          </div>
        </div>
        <p class="text-xs text-white/60 mt-2">A bolha acima √© s√≥ pr√©via. Na transmiss√£o voc√™ tamb√©m ver√° sua c√¢mera sobreposta.</p>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-5 z-50 hidden rounded-xl bg-emerald-600 text-white px-4 py-2 shadow-lg"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const openPopoutBtn = document.getElementById('openPopout');
    const stopAllBtn = document.getElementById('stopAll');
    const toast = document.getElementById('toast');

    const camBubble = document.getElementById('camBubble');
    const camVideo = document.getElementById('camVideo');
    const startCam = document.getElementById('startCam');
    const flipCam = document.getElementById('flipCam');
    const shapeCam = document.getElementById('shapeCam');

    let pop = null;
    let webcamStream = null;
    let flipped = false; let circle=true; let dragging=false, offX=0, offY=0;

    const showToast = (msg, ok=true) => {
      toast.textContent = msg;
      toast.className = `fixed left-1/2 -translate-x-1/2 top-5 z-50 rounded-xl px-4 py-2 shadow-lg ${ok? 'bg-emerald-600':'bg-rose-600'} text-white`;
      toast.style.display = 'block';
      clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none', 2200);
    };
    const setStatus = (text, active) => {
      statusText.textContent = text;
      statusDot.className = `h-2.5 w-2.5 rounded-full ${active? 'bg-emerald-400 animate-pulse':'bg-white/40'}`;
    };

    // === POPUP
    const openPopout = () => {
      if(pop && !pop.closed){ pop.focus(); return pop; }
      pop = window.open('', 'presenter-pop', 'width=1280,height=768,menubar=no,toolbar=no,location=no,status=no');
      if(!pop){ showToast('Permita pop-ups para abrir a janela de transmiss√£o', false); return null; }

      pop.document.write(`<!DOCTYPE html><html><head><meta charset='utf-8'><title>Transmiss√£o</title>
        <style>
          html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
          .top{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;justify-content:center;padding:.6rem;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);}
          .btn{border-radius:12px;padding:.5rem .9rem;font-weight:600;border:none;color:#fff;background:#4f46e5}
          .btn:hover{background:#4338ca}
          #bg{position:fixed;inset:0;width:100%;height:100%;object-fit:contain;background:#000}
          #cam{position:fixed;right:16px;bottom:16px;width:220px;height:220px;border-radius:50%;overflow:hidden;box-shadow:0 10px 20px rgba(0,0,0,.35);border:4px solid #4f46e5;object-fit:cover}
        </style>
      </head><body>
        <div class="top">
          <button id="startShare" class="btn">Iniciar Compartilhamento</button>
          <button id="stopShare" class="btn" style="background:#6b7280">Encerrar</button>
          <span id="tip" style="color:#d1d5db;font-size:12px">Selecione <b>Tela inteira</b> para continuar apresentando mesmo se minimizar outras janelas.</span>
        </div>
        <video id='bg' autoplay playsinline></video>
        <video id='cam' autoplay muted playsinline></video>
        <script>
          let screenStream=null; let camStream=null; let micOn=false;
          const bg=document.getElementById('bg');
          const cam=document.getElementById('cam');
          const start=document.getElementById('startShare');
          const stop=document.getElementById('stopShare');

          window.__applyWebcam = (s)=>{ try{ cam.srcObject=s; cam.play?.(); }catch(e){} };

          start.addEventListener('click', async ()=>{
            try{
              screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: 'always' },
                audio: { echoCancellation:true, noiseSuppression:true }
              });
              bg.srcObject = screenStream; await bg.play?.();
              // manter ativo mesmo se minimizar ESTA aba: n√£o minimize o popout; minimize outras.
              screenStream.getVideoTracks()[0].onended = ()=>{ stop.click(); };
              window.opener?.postMessage({type:'started'}, '*');
            }catch(e){ alert('Captura cancelada ou bloqueada.'); }
          });

          stop.addEventListener('click', ()=>{
            try{ screenStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
            try{ camStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
            window.close();
          });
        <\/script>
      </body></html>`);

      showToast('Popout aberto. Use o bot√£o l√° dentro para iniciar a captura.');
      setStatus('Aguardando captura no popout‚Ä¶', true);
      return pop;
    };

    // === C√ÇMERA (pr√©via + envio ao popout)
    const startWebcam = async ()=>{
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:{ width:{ideal:1280}, height:{ideal:720} }, audio:false });
        webcamStream = s;
        camVideo.srcObject = s; camBubble.classList.remove('hidden');
        if(pop && !pop.closed){ // duplica para o popout
          try{ const clone = new MediaStream(s.getVideoTracks().map(t=>t.clone())); pop.__applyWebcam?.(clone); }catch(e){}
        }
        showToast('C√¢mera ligada');
      }catch(e){ showToast('Permita acesso √† c√¢mera', false); }
    };

    // === UI principal
    openPopoutBtn.addEventListener('click', ()=>{
      openPopout();
    });

    stopAllBtn.addEventListener('click', ()=>{
      try{ webcamStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
      if(pop && !pop.closed) pop.close();
      setStatus('Pronto', false);
    });

    startCam.addEventListener('click', startWebcam);
    flipCam.addEventListener('click', ()=>{ flipped=!flipped; camVideo.style.transform = flipped? 'scaleX(-1)': 'none'; });
    shapeCam.addEventListener('click', ()=>{ circle=!circle; camBubble.style.borderRadius = circle? '9999px':'1rem'; });

    // Drag bubble
    camBubble.addEventListener('mousedown', (e)=>{ if(e.button!==0) return; dragging=true; const r=camBubble.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; document.body.style.userSelect='none'; });
    document.addEventListener('mousemove', (e)=>{ if(!dragging)return; const maxX=window.innerWidth-camBubble.offsetWidth-8; const maxY=window.innerHeight-camBubble.offsetHeight-8; let x=Math.max(8, Math.min(e.clientX-offX, maxX)); let y=Math.max(8, Math.min(e.clientY-offY, maxY)); camBubble.style.left=x+'px'; camBubble.style.top=y+'px'; camBubble.style.right='auto'; camBubble.style.bottom='auto'; });
    document.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });

    // Comunica√ß√£o popout ‚Üí principal (para atualizar status)
    window.addEventListener('message', (ev)=>{
      if(ev.data?.type==='started'){ setStatus('Transmitindo do popout', true); showToast('Transmiss√£o iniciada no popout'); }
    });
  });
  </script>
</body>
</html>
